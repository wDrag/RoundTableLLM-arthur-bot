services:
  master:
    build:
      context: .
      dockerfile: apps/master/Dockerfile
    env_file:
      - .env
    ports:
      - "8787:8787"
    environment:
      - PORT=8787
      - MASTER_API_KEY=${MASTER_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_VERSION=${ANTHROPIC_VERSION}
      - REQUEST_TIMEOUT_MS=${REQUEST_TIMEOUT_MS}
      - RUNNER_CONCURRENCY=${RUNNER_CONCURRENCY}
    volumes:
      - master-data:/app/data
    healthcheck:
      test: ["CMD", "node", "apps/master/dist/healthcheck.js"]
      interval: 10s
      timeout: 3s
      retries: 5
  bot:
    build:
      context: .
      dockerfile: apps/bot/Dockerfile
    depends_on:
      master:
        condition: service_healthy
    ports:
      - "8788:8788"
    environment:
      - MASTER_BASE_URL=http://master:8787
      - BOT_PORT=8788

volumes:
  master-data:
